#+TITLE: Languages Configuration
#+PROPERTY: header-args:emacs-lisp :tangle languages-config.el :mkdirp yes
#+STARTUP: overview

* Header
#+begin_src emacs-lisp
;;; languages-config.el --- Language-specific configurations -*- lexical-binding: t -*-
;;; Commentary:
;; Python, Go, Rust, Clojure, Bash, and Lisp configurations
;;; Code:
#+end_src

* Company (Global Setup)
;; Configure company globally here so all language modes inherit it cleanly.
#+begin_src emacs-lisp
(use-package company
  :ensure t
  :demand t
  :init
  (setq company-idle-delay 0.2
        company-minimum-prefix-length 1
        company-show-quick-access t
        company-tooltip-align-annotations t)
  :config
  (global-company-mode 1))
#+end_src

* Python

** Pyvenv
#+begin_src emacs-lisp
(use-package pyvenv
  :init
  (setenv "WORKON_HOME" "~/.venvs/")
  :config
  (setq pyvenv-post-activate-hooks
        (list (lambda ()
                (setq python-shell-interpreter
                      (concat pyvenv-virtual-env "bin/python")))))
  (setq pyvenv-post-deactivate-hooks
        (list (lambda ()
                (setq python-shell-interpreter "python3")))))
#+end_src

** Blacken (Formatter)
#+begin_src emacs-lisp
(use-package blacken
  :init
  (setq-default blacken-fast-unsafe t)
  (setq-default blacken-line-length 80))
#+end_src

** Python Mode
;; Uses Eglot (configured in programming-config.el) for LSP.
;; company-capf is the bridge between Eglot completions and company-mode.
#+begin_src emacs-lisp
(use-package python-mode
  :hook ((python-mode . pyvenv-mode)
         (python-mode . flycheck-mode)
         (python-mode . blacken-mode)
         (python-mode . yas-minor-mode)
         (python-mode . (lambda ()
                          ;; Eglot exposes completions via capf; make sure
                          ;; company picks that up and nothing else clobbers it.
                          (setq-local company-backends '(company-capf))
                          (company-mode 1))))
  :custom
  (python-shell-interpreter "python3"))
#+end_src

* Go

** Go Mode
#+begin_src emacs-lisp
(use-package go-mode)
#+end_src

** Go Settings
#+begin_src emacs-lisp
(with-eval-after-load 'go-mode
  ;; FIX: exec-path takes directories, not full binary paths.
  (setq exec-path (append exec-path '("/usr/local/go/bin")))
  (setq gofmt-command "goimports")
  (add-hook 'before-save-hook 'gofmt-before-save)
  (add-hook 'go-mode-hook
            (lambda ()
              (setq-local company-backends '(company-capf))
              (company-mode 1))))
#+end_src

* Rust

** Rust Mode
#+begin_src emacs-lisp
(use-package rust-mode
  :hook ((rust-mode . eglot-ensure)
         (rust-mode . (lambda ()
                        (setq-local company-backends '(company-capf))
                        (company-mode 1))))
  :config
  (setq rust-format-on-save t))
#+end_src

** Cargo
#+begin_src emacs-lisp
(use-package cargo
  :hook (rust-mode . cargo-minor-mode))
#+end_src

* Clojure

** Clojure Mode
#+begin_src emacs-lisp
(use-package clojure-mode
  :defer t)
#+end_src

** Cider
#+begin_src emacs-lisp
(use-package cider
  :hook (cider-repl-mode . company-mode))
#+end_src

** Clj-Refactor
#+begin_src emacs-lisp
(use-package clj-refactor
  :config
  (add-hook 'clojure-mode-hook
            (lambda ()
              (clj-refactor-mode 1)
              (company-mode 1)))
  (cljr-add-keybindings-with-prefix "C-c C-m")
  (setq cljr-warn-on-eval nil))
#+end_src

* Shell/Bash

** Company Shell
#+begin_src emacs-lisp
(use-package company-shell
  :config
  (defun shell-mode-company-init ()
    (setq-local company-backends
                '((company-shell
                   company-shell-env
                   company-etags
                   company-dabbrev-code)))
    (company-mode 1))

  (add-hook 'shell-mode-hook 'shell-mode-company-init)
  (add-hook 'shell-mode-hook 'yas-minor-mode)
  (add-hook 'shell-mode-hook 'flycheck-mode))
#+end_src

* Emacs Lisp

#+begin_src emacs-lisp
(add-hook 'emacs-lisp-mode-hook 'eldoc-mode)
(add-hook 'emacs-lisp-mode-hook 'yas-minor-mode)
(add-hook 'emacs-lisp-mode-hook 'company-mode)
#+end_src

* Common Lisp

** Slime
#+begin_src emacs-lisp
(use-package slime
  :config
  (setq inferior-lisp-program "/usr/bin/sbcl")
  (setq slime-contribs '(slime-fancy)))
#+end_src

** Slime Company
#+begin_src emacs-lisp
(use-package slime-company
  :after (slime company)
  :config
  (slime-setup '(slime-fancy slime-company)))
#+end_src

* Footer
#+begin_src emacs-lisp
(provide 'languages-config)
;;; languages-config.el ends here
#+end_src